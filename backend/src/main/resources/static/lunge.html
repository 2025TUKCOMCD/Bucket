<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Workout Screen</title>
    <style>
        :root {
            --primary-color:   #3a86ff;
            --secondary-color: #8338ec;
            --dark-color:      #1a1a2e;
            --light-color:     #f8f9fa;
            --radius:          8px;
        }
        * { margin:0; padding:0; box-sizing:border-box }
        body {
            font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:var(--dark-color);
            color:var(--light-color);
            padding:20px;
        }
        .container { max-width:1400px; margin:0 auto }
        header { text-align:center; margin-bottom:30px }
        h1 { font-size:2.5rem; color:var(--secondary-color); }

        .video-container {
            display:flex; flex-wrap:wrap; gap:20px; margin-bottom:30px;
        }
        .video-box {
            flex:1; min-width:300px;
            background:rgba(255,255,255,0.05);
            border-radius:var(--radius);
            overflow:hidden;
            box-shadow:0 4px 6px rgba(0,0,0,0.1);
        }
        .video-header {
            padding:10px 15px;
            background:var(--secondary-color);
            color:white;
            font-weight:bold;
        }
        .video-box:nth-child(1) .video-header {
            background:var(--primary-color);
        }
        .video-content {
            /* ê¸°ë³¸ padding */
            padding:15px;
        }
        video {
            width:100%; height:auto; border-radius:var(--radius);
        }

        /* â”€â”€â”€ My Video ë¶€ë¶„ë§Œ ìˆ˜ì • â”€â”€â”€ */
        /* My Video ì»¨í…Œì´ë„ˆë¥¼ 16:9ë¡œ ê³ ì •í•˜ê³  ë‚´ë¶€ ì—¬ë°± ì œê±° */
        .video-box:first-child .video-content {
            padding: 0;
            aspect-ratio: 16 / 9;
            position: relative;
            overflow: hidden; /* â˜… ë³€ê²½: íšŒì „ í›„ ì‚ì ¸ë‚˜ì˜¤ëŠ” ì˜ì—­ ì˜ë¼ë‚´ê¸° */
            flex: 1;
        }
        /* â˜… ë³€ê²½: íšŒì „ëœ ë¹„ë””ì˜¤ê°€ ì»¨í…Œì´ë„ˆë¥¼ ê½‰ ì±„ìš°ë„ë¡ object-fit: cover ì ìš© */
        .video-box:first-child .video-content video {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotate(90deg);
            transform-origin: center center;
            width: 200%;              /* â˜… ë³€ê²½: ê°€ë¡œ/ì„¸ë¡œ ëª¨ë‘ 100%ë¡œ ì±„ìš°ê¸° */
            height: 200%;             /* â˜… ë³€ê²½ */
            object-fit: contain;        /* â˜… ë³€ê²½: ë¹ˆ ì—¬ë°± ì—†ì´ ê½‰ ì±„ìš°ë˜ ì¼ë¶€ í¬ë¡­ í—ˆìš© */
            border-radius: 0 0 var(--radius) var(--radius);
        }
        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

        .text-output {
            background:rgba(255,255,255,0.05);
            border-radius:var(--radius);
            padding:20px;
            margin-bottom:30px;
            min-height:200px;
            box-shadow:0 4px 6px rgba(0,0,0,0.1);
        }
        .text-output h2 { color:var(--primary-color); margin-bottom:15px }
        .text-output-content {
            background:rgba(0,0,0,0.2);
            padding:15px;
            border-radius:var(--radius);
            min-height:120px;
            font-family:monospace;
            overflow-y:auto;
        }

        @media(max-width:768px){
            .video-container { flex-direction:column }
            .video-box { min-width:100% }
            h1 { font-size:1.8rem }
        }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1>Lunge</h1>
        <p>ë³¸ì¸ ìš´ë™ ì˜ìƒê³¼ ì •ì„ ëŸ°ì§€ ìì„¸ë¥¼ ë¹„êµí•´ë³´ì„¸ìš”!</p>
    </header>

    <div class="video-container">
        <div class="video-box">
            <div class="video-header">My Video</div>
            <div class="video-content">
                <video id="video1" autoplay playsinline controls></video>
            </div>
        </div>
        <div class="video-box">
            <div class="video-header">
                <span>Reference Video</span>
            </div>
            <div class="video-content" style="padding: 0; flex: 1; display: flex; justify-content: center; align-items: center;">
                <img src="/img/lunge.gif" alt="Reference GIF" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
        </div>
    </div>

    <div class="text-output">
        <h2>Real-time Feedback</h2>
        <div class="text-output-content" id="result"></div>
    </div>
    <button onclick="startRecording()">ë…¹í™” ì‹œì‘</button>
    <button onclick="stopRecording()">ë…¹í™” ì¢…ë£Œ</button>
</div>
<div id="recording-timer" style="font-size: 20px; color: #00ff99; margin-top: 10px;">
    ë…¹í™” ì‹œê°„: 00:00
</div>

<script>
    // âœ… ì‹œê·¸ë„ë§ ì„œë²„ URL
    const signalingUrl = 'wss://homept.online/signaling';
    const signalingConnection = new WebSocket(signalingUrl);

    // âœ… í¬ì¦ˆ ë°ì´í„° ì „ìš© WebSocket
    const poseUrl = 'wss://homept.online/pose';
    //const poseUrl = 'ws://localhost:8080/pose'
    const poseConnection = new WebSocket(poseUrl);

    // let peerConnection;
    // const config = {
    //     iceServers: [
    //         { urls: 'stun:stun.l.google.com:19302' },
    //         {
    //             urls: 'turn:3.39.137.250:3478',
    //             username: 'unused',              // static-auth-secret ì‚¬ìš© ì‹œ íŠ¹ë³„í•œ ì˜ë¯¸ ì—†ìŒ
    //             credential: 'secret-bucket123'   // ìœ„ turnserver.confì˜ static-auth-secret ê°’
    //         }
    //     ]
    // };

    let peerConnection;
    const config = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            {
                urls: 'turn:3.39.137.250:3478',
                username: 'webrtcuser',              // static-auth-secret ì‚¬ìš© ì‹œ íŠ¹ë³„í•œ ì˜ë¯¸ ì—†ìŒ
                credential: 'secret-bucket123'   // ìœ„ turnserver.confì˜ static-auth-secret ê°’
            }
        ]
    };

    // const pc = new RTCPeerConnection({
    //     iceServers: [
    //         { urls: 'stun:stun.l.google.com:19302' },
    //         {
    //             urls: "turn:3.39.137.250:3478",
    //             username: "webrtcuser",
    //             credential: "secret-bucket123"
    //         }
    //     ]
    // });

    // video ìš”ì†Œ ì„ íƒ
    const video1 = document.getElementById('video1');
    const video2 = document.getElementById('video2');
    const resultDiv = document.getElementById('result');

    // âœ… ì‹œê·¸ë„ë§ ì„œë²„ ì—°ê²° ì´ë²¤íŠ¸
    signalingConnection.onopen = () => {
        console.log('[âœ… ì‹œê·¸ë„ë§] ì„œë²„ì— ì—°ê²°ë¨');
        createPeerConnection();
    };

    // âœ… ì‹œê·¸ë„ë§ ì„œë²„ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ 
    signalingConnection.onmessage = (message) => {
        const data = JSON.parse(message.data);
        console.log('[ğŸ“© ì‹œê·¸ë„ë§ ë©”ì‹œì§€ ìˆ˜ì‹ ]:', data);

        if (data.type === 'offer') {
            // offer ìˆ˜ì‹  ì‹œ remote description ì„¤ì •
            peerConnection.setRemoteDescription(new RTCSessionDescription(data));
            peerConnection.createAnswer().then(answer => {
                return peerConnection.setLocalDescription(answer);
            }).then(() => {
                signalingConnection.send(JSON.stringify(peerConnection.localDescription));
            });
        } else if (data.type === 'answer') {
            // ì—°ê²° ìƒíƒœ í™•ì¸ í›„ answer ì²˜ë¦¬
            if (peerConnection.signalingState === 'have-local-offer') {
                peerConnection.setRemoteDescription(new RTCSessionDescription(data));
            } else {
                console.warn('Remote answerë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤. í˜„ì¬ signaling state:', peerConnection.signalingState);
            }
        } else if (data.type === 'candidate') {
            // ICE candidate ì²˜ë¦¬
            let candidateObj;
            if (typeof data.candidate === 'object' && data.candidate !== null) {
                candidateObj = data.candidate;
            } else {
                candidateObj = {
                    candidate: data.candidate,
                    sdpMid: data.sdpMid,
                    sdpMLineIndex: data.sdpMLineIndex
                };
            }
            const candidateInit = {
                candidate: candidateObj.candidate,
                sdpMid: candidateObj.sdpMid,
                sdpMLineIndex: typeof candidateObj.sdpMLineIndex === 'string'
                    ? Number(candidateObj.sdpMLineIndex)
                    : candidateObj.sdpMLineIndex
            };

            if (!candidateInit.sdpMid && (candidateInit.sdpMLineIndex === null || candidateInit.sdpMLineIndex === undefined)) {
                console.warn('[âš ï¸ ì˜ëª»ëœ ICE Candidate ìˆ˜ì‹ ]:', data);
                return;
            }
            peerConnection.addIceCandidate(new RTCIceCandidate(candidateInit));
        }
    };



    // âœ… í¬ì¦ˆ ë°ì´í„° ì„œë²„ ì—°ê²° ì´ë²¤íŠ¸
    poseConnection.onopen = () => {
        console.log('[âœ… í¬ì¦ˆ ë°ì´í„°] ì„œë²„ì— ì—°ê²°ë¨');
    };

    // âœ… í¬ì¦ˆ ë°ì´í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
    poseConnection.onmessage = (message) => {
        // const data = JSON.parse(message.data);
        // console.log('[ğŸ“© í¬ì¦ˆ ë°ì´í„° ìˆ˜ì‹ ]:', data);
        // í¬ì¦ˆ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ í™”ë©´ ì—…ë°ì´íŠ¸ ê°€ëŠ¥

        const data = JSON.parse(message.data);
        console.log('AI ì‘ë‹µ ìˆ˜ì‹ : ',data.prediction_result);

        const resultDiv = document.getElementById('result');
        resultDiv.innerText = data.prediction_result;

    };

    poseConnection.onerror = (error) => {
        console.error('AI WebSocket ì˜¤ë¥˜: ',error);
    }

    function createPeerConnection() {
        peerConnection = new RTCPeerConnection(config);

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                console.log('[ğŸ“¤ ICE Candidate ì „ì†¡]:', event.candidate);
                signalingConnection.send(JSON.stringify({
                    type: 'candidate',
                    candidate: event.candidate
                }));
            }
        };

        // âœ… ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ì‹œ video1ì— í• ë‹¹
        peerConnection.ontrack = event => {
            console.log('[ğŸ¥ ì›ê²© ë¹„ë””ì˜¤ ìˆ˜ì‹ ]');
            video1.srcObject = event.streams[0];
        };

        // âœ… ë¡œì»¬ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì¶”ê°€ (í•„ìš”í•˜ë©´ í™œì„±í™”)
        /*
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
                video2.srcObject = stream;
            })
            .catch(error => console.error('[âŒ getUserMedia ì—ëŸ¬]:', error));
        */
    }

    function createOffer() {
        peerConnection.createOffer().then(offer => {
            return peerConnection.setLocalDescription(offer);
        }).then(() => {
            signalingConnection.send(JSON.stringify(peerConnection.localDescription));
        });
    }

    let currentUid = null;

    // í˜ì´ì§€ ë¡œë“œì‹œ uidë¥¼ ì„œë²„ì—ì„œ fetch
    window.onload = () => {

        fetch("/api/user/me", {
            method: "GET",
            credentials: "include"  // ì„¸ì…˜ ì¿ í‚¤ í¬í•¨ í•„ìˆ˜
        })
            .then(res => {
                if (!res.ok) throw new Error("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤");
                return res.json();
            })
            .then(user => {
                currentUid = user.uid;
                console.log("í˜„ì¬ ë¡œê·¸ì¸ëœ ì‚¬ìš©ì uid:", currentUid);
            })
            .catch(err => {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                window.location.href = "/login.html";
            });
    };


    let mediaRecorder=null;
    console.log("mediaRecorder ì´ˆê¸°ê°’:", mediaRecorder);
    let recordedChunks = [];
    let timerInterval;
    let recordingStartTime = null;
    let sharedStream = null;

    function startRecording() {
        //const stream = video1.srcObject;

        navigator.mediaDevices.getDisplayMedia({video : true, audio: false})
            .then(stream => {
                sharedStream = stream;
                console.log("stream tracks:", stream.getVideoTracks());
                mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

                recordedChunks = [];

                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    uploadToServer(blob);
                    stopTimer();
                };

                mediaRecorder.start();
                console.log("í™”ë©´ ë…¹í™” ì‹œì‘");

                startTimer();
            })
            .catch(err => {
                console.error("í™”ë©´ ë…¹í™” ì˜¤ë¥˜:", err);
            });
        // if (!stream) {
        //     console.warn("ìŠ¤íŠ¸ë¦¼ì´ ì•„ì§ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        //     return;
        // }
    }


    function stopRecording() {

        console.log("[ë…¹í™”] mediaRecorder í˜„ì¬ ìƒíƒœ:", mediaRecorder);


        if(sharedStream){
            sharedStream.getTracks().forEach(track => track.stop());
            sharedStream=null;
            console.log("í™”ë©´ ê³µìœ  ì¤‘ì§€ë¨");
        }
        else {
            console.warn("ë…¹í™”ê°€ ì•„ì§ ì‹œì‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
    }

    function uploadToServer(blob) {
        const formData = new FormData();
        if(!currentUid){
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            return;
        }
        formData.append("file", blob);
        formData.append("uid", currentUid);

        fetch("/api/user-videos/upload", {
            method: "POST",
            body: formData
        })
            .then(res => res.text())
            .then(url => {
                console.log("ì—…ë¡œë“œ ì™„ë£Œ: " + url); //S3ì— ì—…ë¡œë“œ
            })
            .catch(err => console.error("ì—…ë¡œë“œ ì‹¤íŒ¨", err));
    }

    // íƒ€ì´ë¨¸ ì‹œì‘
    function startTimer() {
        const timerEl = document.getElementById("recording-timer");
        recordingStartTime = Date.now();

        timerInterval = setInterval(() => {
            const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
            const minutes = String(Math.floor(elapsed / 60)).padStart(2, "0");
            const seconds = String(elapsed % 60).padStart(2, "0");
            timerEl.textContent = `ë…¹í™” ì‹œê°„: ${minutes}:${seconds}`;
        }, 1000);
    }

    // â¹ íƒ€ì´ë¨¸ ì¢…ë£Œ
    function stopTimer() {
        clearInterval(timerInterval);
        document.getElementById("recording-timer").textContent = "ë…¹í™” ì‹œê°„: 00:00";
    }


</script>
</body>
</html>