<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Screen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
        }
    </style>
</head>
<body class="bg-white flex flex-col items-center justify-center min-h-screen p-4">
<div class="w-full h-full bg-gray-100 p-6 rounded-lg shadow-md flex flex-col">
    <!-- ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ -->
    <div class="flex-1 flex flex-row gap-4">
        <!-- ìŠ¤íŠ¸ë¦¬ë° ì˜ìƒ í‘œì‹œë¥¼ ìœ„í•œ video íƒœê·¸ -->
        <video id="video1" class="flex-1 rounded-lg aspect-video" autoplay playsinline controls></video>
        <video id="video2" class="flex-1 rounded-lg aspect-video" autoplay playsinline controls></video>
    </div>
    <!-- ê²°ê³¼ ì»¨í…Œì´ë„ˆ -->
    <div class="w-full h-1/6 bg-white flex items-center justify-center text-lg font-semibold rounded-lg mt-4" id="result">
        <!-- ìŠ¤íŠ¸ë¦¬ë° ê´€ë ¨ ìƒíƒœë‚˜ ê²°ê³¼ ë©”ì‹œì§€ ì¶œë ¥ -->
        Text Result
    </div>
</div>

<script>
    // âœ… ì‹œê·¸ë„ë§ ì„œë²„ URL
    const signalingUrl = 'ws://15.165.138.10:8080/signaling';
    const signalingConnection = new WebSocket(signalingUrl);

    // âœ… í¬ì¦ˆ ë°ì´í„° ì „ìš© WebSocket
    const poseUrl = 'ws://15.165.138.10:8080/pose';
    const poseConnection = new WebSocket(poseUrl);

    let peerConnection;
    const config = {
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            {
                urls: 'turn:YOUR_EC2_PUBLIC_IP:3478',
                username: 'unused',
                credential: 'YOUR_STATIC_SECRET'
            }
        ]
    };

    // video ìš”ì†Œ ì„ íƒ
    const video1 = document.getElementById('video1');
    const video2 = document.getElementById('video2');
    const resultDiv = document.getElementById('result');

    // âœ… ì‹œê·¸ë„ë§ ì„œë²„ ì—°ê²° ì´ë²¤íŠ¸
    signalingConnection.onopen = () => {
        console.log('[âœ… ì‹œê·¸ë„ë§] ì„œë²„ì— ì—°ê²°ë¨');
        createPeerConnection();
    };

    // âœ… ì‹œê·¸ë„ë§ ì„œë²„ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì‹ 
    signalingConnection.onmessage = (message) => {
        const data = JSON.parse(message.data);
        console.log('[ðŸ“© ì‹œê·¸ë„ë§ ë©”ì‹œì§€ ìˆ˜ì‹ ]:', data);

        if (data.type === 'offer') {
            peerConnection.setRemoteDescription(new RTCSessionDescription(data));
            peerConnection.createAnswer().then(answer => {
                return peerConnection.setLocalDescription(answer);
            }).then(() => {
                signalingConnection.send(JSON.stringify(peerConnection.localDescription));
            });
        } else if (data.type === 'answer') {
            peerConnection.setRemoteDescription(new RTCSessionDescription(data));
        } else if (data.type === 'candidate') {
            if (!data.sdpMid || data.sdpMLineIndex === null) {
                console.warn('[âš ï¸ ìž˜ëª»ëœ ICE Candidate ìˆ˜ì‹ ]:', data);
                return;
            }
            peerConnection.addIceCandidate(new RTCIceCandidate(data));
        }
    };

    // âœ… í¬ì¦ˆ ë°ì´í„° ì„œë²„ ì—°ê²° ì´ë²¤íŠ¸
    poseConnection.onopen = () => {
        console.log('[âœ… í¬ì¦ˆ ë°ì´í„°] ì„œë²„ì— ì—°ê²°ë¨');
    };

    // âœ… í¬ì¦ˆ ë°ì´í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
    poseConnection.onmessage = (message) => {
        const data = JSON.parse(message.data);
        console.log('[ðŸ“© í¬ì¦ˆ ë°ì´í„° ìˆ˜ì‹ ]:', data);
        // í¬ì¦ˆ ë°ì´í„°ë¥¼ í™œìš©í•˜ì—¬ í™”ë©´ ì—…ë°ì´íŠ¸ ê°€ëŠ¥
    };

    function createPeerConnection() {
        peerConnection = new RTCPeerConnection(config);

        peerConnection.onicecandidate = event => {
            if (event.candidate) {
                console.log('[ðŸ“¤ ICE Candidate ì „ì†¡]:', event.candidate);
                signalingConnection.send(JSON.stringify({
                    type: 'candidate',
                    candidate: event.candidate
                }));
            }
        };

        // âœ… ì›ê²© ìŠ¤íŠ¸ë¦¼ ìˆ˜ì‹  ì‹œ video1ì— í• ë‹¹
        peerConnection.ontrack = event => {
            console.log('[ðŸŽ¥ ì›ê²© ë¹„ë””ì˜¤ ìˆ˜ì‹ ]');
            video1.srcObject = event.streams[0];
        };

        // âœ… ë¡œì»¬ ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ì¶”ê°€ (í•„ìš”í•˜ë©´ í™œì„±í™”)
        /*
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                stream.getTracks().forEach(track => peerConnection.addTrack(track, stream));
                video2.srcObject = stream;
            })
            .catch(error => console.error('[âŒ getUserMedia ì—ëŸ¬]:', error));
        */
    }

    function createOffer() {
        peerConnection.createOffer().then(offer => {
            return peerConnection.setLocalDescription(offer);
        }).then(() => {
            signalingConnection.send(JSON.stringify(peerConnection.localDescription));
        });
    }
</script>

</body>
</html>
